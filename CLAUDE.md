# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Python utility project for downloading events from a cigarette vending machine's web interface. The project consists of a single Python script that interacts with a local web admin panel to extract event data.

## Core Files

- `download_events.py` - Main Python script that handles authentication and event download
- `cigarette_machine_simulator.py` - Flask-based simulator for offline testing
- `sales_analyzer.py` - Analyzes events 
- `dashboard_server.py` - Web dashboard server for monitoring sales
- `monitor_sales.py` - Automatic monitoring script for continuous updates
- `start_dashboard.sh` - Quick start script for dashboard system (legacy)
- `start_system.sh` - NEW: Unified startup script for both production and simulation
- `api_server.py` - NEW: Minimal Flask API server separated from dashboard
- `dashboard/` - NEW: Modern static dashboard with Tailwind CSS
- `README_events.md` - Comprehensive documentation with usage examples
- Event output files (`events_*.json`, `events_*.html`) - Generated by the script (gitignored)
- `sales_data.db` - SQLite database with sales tracking (gitignored)

## Common Commands

### Running the Script

```bash
# Basic usage with real vending machine (downloads last 30 days)
python3 download_events.py

# Custom filename and timeframe
python3 download_events.py eventi_$(date +%Y%m%d).html 90

# Download full year of events
python3 download_events.py eventi_anno.html 365

# SIMULATOR MODE - for offline testing
# Terminal 1: Start simulator
python3 cigarette_machine_simulator.py

# Terminal 2: Run script with simulator
python3 download_events.py --simulator
python3 download_events.py --simulator eventi_test.html 7
```

### Sales Dashboard System

```bash
# NEW: Development mode with cache busting (recommended for development)
./start_dev.sh                       # Auto cache busting, both servers
./watch_and_reload.sh                # Auto reload on file changes (optional)

# NEW: Unified system startup (recommended for production)
./start_system.sh                    # Interactive menu
./start_system.sh --quick-sim        # Quick simulation mode
./start_system.sh --quick-prod       # Quick production mode

# Legacy: Old dashboard system
./start_dashboard.sh                 # Uses old monolithic dashboard_server.py

# Manual setup (new architecture):
# 1. Start API server
python3 api_server.py --ip localhost --port 8000     # Simulation mode
python3 api_server.py --ip 192.168.1.65 --port 8000 # Production mode

# 2. Start static dashboard
cd dashboard && python3 -m http.server 3000

# 3. (For simulation) Start simulator
python3 cigarette_machine_simulator.py

# Dashboard available at: http://localhost:3000
# API available at: http://localhost:8000
```

### Development Features

**Cache Busting System:**
- Automatic timestamp-based cache busting for JS files
- Meta tags to prevent browser caching during development
- `start_dev.sh` - Development server with anti-cache features
- `watch_and_reload.sh` - Auto-reload on file changes (optional)

**Mobile & Remote Access:**
- Fixed mobile hamburger menu visibility
- Dynamic API URLs for remote network access
- Responsive design optimized for mobile devices

### Dependencies

```bash
# Install required Python packages
pip3 install requests flask flask-cors
```

## Architecture

The codebase is structured around a single `EventDownloader` class that:

1. **Authentication**: Handles login to the vending machine's web interface at `192.168.1.65:1500`
2. **Event Retrieval**: Downloads both HTML pages and JSON event data
3. **Session Management**: Maintains browser-like session with proper headers and cookies
4. **Cleanup**: Automatically exits programming mode on the device after operations

### Key Components

- **EventDownloader class** (`download_events.py:12-200`):
  - `login()` - Authenticates with hardcoded credentials
  - `download_events()` - Downloads HTML event page
  - `download_events_data()` - Fetches JSON event data via API
  - `download_and_parse_events()` - Combined HTML + JSON download
  - `exit_programming_mode()` - Safely exits device programming mode

### Output Files

The script generates three types of files:
- **HTML file**: Complete event page (`events_YYYYMMDD_HHMMSS.html`)
- **Complete JSON**: Metadata + events (`events_YYYYMMDD_HHMMSS_complete.json`)
- **Events-only JSON**: Pure event data (`events_YYYYMMDD_HHMMSS_events_only.json`)

## Configuration

### Credentials

Default credentials are hardcoded in the `EventDownloader.__init__()` method:
- Username: `"Andrea1976"`
- Base URL: `"http://192.168.1.65:1500"`

### Git Configuration

The `.gitignore` excludes all generated output files:
- `*.json` - Event data files
- `*.html` - Downloaded pages
- `.DS_Store` - macOS system files

## Simulator Architecture

The `cigarette_machine_simulator.py` provides a complete Flask-based simulation:

- **Flask server** on port 1500 (same as real device)
- **Authentication simulation** - accepts password "Andrea1976"
- **Event data loading** - uses existing `sample_data.json`
- **Date filtering** - simulates real API behavior for date ranges
- **Full endpoint compatibility** - `/login`, `/events2`, `/events2_query`, `/admin_index_back`

### Simulator vs Real Device

- **Real device**: `python3 download_events.py` → connects to `192.168.1.65:1500`
- **Simulator**: `python3 download_events.py --simulator` → connects to `localhost:1500`
- **Identical behavior** - same authentication, API calls, and output files

## Dashboard Features

The sales dashboard provides:

- **Visual Motor Grid**: 70+ motors
- **Sales Statistics**: Daily sales, revenue, and performance metrics
- **Smart Alerts**: Automatic detection of problems (not yet implemented)
- **Responsive Design**: Works on desktop, tablet, and mobile devices
- **Auto-refresh**: Updates every 30 seconds for real-time monitoring
- **API Endpoints**: RESTful API for integration with other systems


## Important Notes

- The script automatically handles device programming mode exit for safety
- Requires network access to the local vending machine at `192.168.1.65:1500` (or localhost for simulator)
- Uses browser-like headers to avoid request blocking
- All output files are gitignored to prevent committing potentially sensitive event data
- **Simulator mode** allows complete offline testing without physical hardware

## File Management and Archiving

### JSON File Organization

- **Sample Data**: `simulator/sample_data.json` - File dati esempio per il simulatore (tracked in git)
- **Generated Events**: Tutti i file JSON generati dai download vengono automaticamente archiviati in `backend/past_events/`
- **Auto-cleanup**: I file più vecchi di 30 giorni vengono rimossi automaticamente

### .gitignore Policy

```
*.json                          # Esclude tutti i JSON
!simulator/sample_data.json     # Eccetto i dati campione del simulatore
!.claude/settings.local.json    # Eccetto le impostazioni Claude
backend/past_events/            # Esclude l'intera directory archivio
```

### Download Behavior

Il backend ora:
1. Scarica eventi dal distributore/simulatore
2. **Salva solo il file JSON** (rimuove l'HTML)
3. **Sposta il JSON in `backend/past_events/`**
4. **Esegue cleanup automatico** dei file > 30 giorni
5. Processa i dati per la dashboard



### Setup Produzione
 # Copiare solo la cartella dist + backend
  frontend-vue/dist/  → Servito da python3 -m http.server
  backend/           → API server Python

  # Avvio (2 comandi)
  cd frontend-vue/dist && python3 -m http.server 3000 &
  cd backend && python3 api_server.py --ip 0.0.0.0 --port 8000 &
