# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Python utility project for downloading events from a cigarette vending machine's web interface. The project consists of a single Python script that interacts with a local web admin panel to extract event data.

## Environment Configuration

This project uses environment variables for all configuration to avoid hardcoded credentials and IPs.

### Quick Setup

1. Copy the example file:
   ```bash
   cp .env.example .env
   ```

2. Edit `.env` with your network settings:
   ```bash
   # Change these IPs if your network is different
   DISTRIBUTOR_IP=ip_address    # Your vending machine IP
   SERVER_IP=ip_address         # Your dev machine IP
   DISTRIBUTOR_PASSWORD=Username # Admin username
   ```

3. Install Python dependency:
   ```bash
   pip3 install python-dotenv
   ```

### Variable Priority

Configuration is loaded in this order (highest to lowest priority):

1. **Command-line arguments** (highest) - `./start_vue_system.sh --ip 192.168.1.100`
2. **Environment variables** - from `.env` file
3. **Default values** (fallback) - hardcoded in `shared/config.py`

### Available Variables

See `.env.example` for complete list.

**Required (no defaults):**
- `DISTRIBUTOR_IP` - Vending machine IP address
- `DISTRIBUTOR_PASSWORD` - Admin username/password

**Optional (have defaults):**
- `API_PORT` - API server port (default: 8000)
- `FRONTEND_PORT` - Frontend port (default: 3000)
- `DISTRIBUTOR_PORT` - Distributor connection port (default: 1500)
- `DB_PATH` - Database path (default: sales_data.db)

**Note:** Simulator always uses `localhost:1500` (hardcoded, no configuration needed)

### Frontend Configuration

Frontend uses a single `.env` file in `frontend-vue/`:
- **Single `.env` file** - Works for both dev (`npm run dev`) and production (`npm run build`)
- Variables prefixed with `VITE_` are injected at build time
- **Server IP auto-detected**: Frontend automatically uses `window.location.hostname` - works from any device without configuration!
- **Only 1 variable required**: `VITE_DISTRIBUTOR_IP` (IP of vending machine)

### Testing Configuration

Verify your environment setup:
```bash
python3 scripts/verify_env.py
```

This shows which values are loaded from `.env` vs defaults.

## Core Files

### Main Scripts
- `start.sh` - Unified startup script for macOS/Linux (production and simulation)
- `start.bat` - Unified startup script for Windows (identical behavior to start.sh)
- `download_events.py` - Main Python script that handles authentication and event download
- `cigarette_machine_simulator.py` - Flask-based simulator for offline testing

### Backend
- `backend/api_server.py` - Flask API server for dashboard
- `backend/download_events.py` - CLI script for downloading events
- `backend/cigarette_machine_client.py` - Client class for vending machine communication

### Frontend
- `frontend-vue/` - Modern Vue.js PWA dashboard with Tailwind CSS
- `frontend-vue/dist/` - Production build output (gitignored, generated by build)

### Database & Analytics
- `sales_analyzer.py` - Analyzes events
- `sales_data.db` - SQLite database with sales tracking (gitignored)

### Legacy Files (still available)
- `start_dashboard.sh` - Old dashboard system (monolithic)
- `dashboard/` - Old static dashboard with Tailwind CSS

### Output Files (gitignored)
- Event files: `events_*.json`, `events_*.html`
- Process tracking: `.vue_pids`

## Common Commands

### Running the Script

```bash
# Basic usage with real vending machine (downloads last 30 days)
python3 download_events.py

# Custom filename and timeframe
python3 download_events.py eventi_$(date +%Y%m%d).html 90

# Download full year of events
python3 download_events.py eventi_anno.html 365

# SIMULATOR MODE - for offline testing
# Terminal 1: Start simulator
python3 cigarette_machine_simulator.py

# Terminal 2: Run script with simulator
python3 download_events.py --simulator
python3 download_events.py --simulator eventi_test.html 7
```

### Sales Dashboard System

#### macOS/Linux
```bash
# Unified system startup (recommended)
./start.sh                           # Interactive menu
./start.sh --ip localhost            # Simulation mode
./start.sh --ip 192.168.1.65         # Production mode with custom IP

# Legacy: Old dashboard system
./start_dashboard.sh                 # Uses old monolithic dashboard_server.py
```

#### Windows
```powershell
# Unified system startup (identical to macOS/Linux)
start.bat                            # Interactive menu
start.bat --ip localhost             # Simulation mode
start.bat --ip 192.168.1.65          # Production mode with custom IP
```

#### Manual setup (all platforms)
```bash
# 1. Start API server
python3 api_server.py --ip localhost --port 8000     # Simulation mode
python3 api_server.py --ip 192.168.1.65 --port 8000 # Production mode

# 2. Start static dashboard
cd frontend-vue/dist && python3 -m http.server 3000

# 3. (For simulation) Start simulator
python3 simulator/vending_machine_simulator.py

# Dashboard available at: http://localhost:3000
# API available at: http://localhost:8000
```

### Development Features

**Cache Busting System:**
- Automatic timestamp-based cache busting for JS files
- Meta tags to prevent browser caching during development
- `start_dev.sh` - Development server with anti-cache features
- `watch_and_reload.sh` - Auto-reload on file changes (optional)

**Mobile & Remote Access:**
- Fixed mobile hamburger menu visibility
- Dynamic API URLs for remote network access
- Responsive design optimized for mobile devices

### Dependencies

```bash
# Install required Python packages
pip3 install requests flask flask-cors python-dotenv
```

## Architecture

The codebase is structured around modular components with centralized configuration:

1. **Authentication**: Handles login to the vending machine's web interface (IP from env vars)
2. **Event Retrieval**: Downloads both HTML pages and JSON event data
3. **Session Management**: Maintains browser-like session with proper headers and cookies
4. **Cleanup**: Automatically exits programming mode on the device after operations

### Key Components

- **shared/config.py** - Central configuration module that loads from environment variables
- **backend/cigarette_machine_client.py** - Client class for communicating with vending machine
  - `login()` - Authenticates using credentials from Config
  - `download_events_html()` - Downloads HTML event page
  - `download_events_data()` - Fetches JSON event data via API
  - `exit_programming_mode()` - Safely exits device programming mode
- **backend/api_server.py** - Flask API server for dashboard
- **backend/download_events.py** - CLI script for downloading events

### Output Files

The script generates three types of files:
- **HTML file**: Complete event page (`events_YYYYMMDD_HHMMSS.html`)
- **Complete JSON**: Metadata + events (`events_YYYYMMDD_HHMMSS_complete.json`)
- **Events-only JSON**: Pure event data (`events_YYYYMMDD_HHMMSS_events_only.json`)

## Configuration Details

### Credentials and Network

All configuration is managed through environment variables. **Do not hardcode credentials in code.**

Default values are defined in `shared/config.py` and can be overridden via:
1. `.env` file in project root
2. Command-line arguments (highest priority)

For custom network setup, copy `.env.example` to `.env` and modify the values.

### Git Configuration

The `.gitignore` excludes:
- `*.json` - Event data files
- `*.html` - Downloaded pages
- `.env` - Environment variables (local configuration)
- `.DS_Store` - macOS system files

**Tracked files:**
- `.env.example` - Template for environment variables
- `frontend-vue/.env.development` - Frontend dev configuration
- `frontend-vue/.env.production` - Frontend production configuration

## Simulator Architecture

The `cigarette_machine_simulator.py` provides a complete Flask-based simulation:

- **Flask server** - Port configured via `SIMULATOR_PORT` env var (default: 1500)
- **Authentication simulation** - Password from `DISTRIBUTOR_PASSWORD` env var
- **Event data loading** - uses existing `sample_data.json`
- **Date filtering** - simulates real API behavior for date ranges
- **Full endpoint compatibility** - `/login`, `/events2`, `/events2_query`, `/admin_index_back`

### Simulator vs Real Device

- **Real device**: `python3 download_events.py` → connects to IP from `DISTRIBUTOR_IP` env var
- **Simulator**: `python3 download_events.py --ip localhost` → connects to `localhost:1500`
- **Identical behavior** - same authentication, API calls, and output files

## Dashboard Features

The sales dashboard provides:

- **Visual Motor Grid**: 70+ motors
- **Sales Statistics**: Daily sales, revenue, and performance metrics
- **Smart Alerts**: Automatic detection of problems (not yet implemented)
- **Responsive Design**: Works on desktop, tablet, and mobile devices
- **Auto-refresh**: Updates every 30 seconds for real-time monitoring
- **API Endpoints**: RESTful API for integration with other systems


## Important Notes

- The script automatically handles device programming mode exit for safety
- Requires network access to the local vending machine at `192.168.1.65:1500` (or localhost for simulator)
- Uses browser-like headers to avoid request blocking
- All output files are gitignored to prevent committing potentially sensitive event data
- **Simulator mode** allows complete offline testing without physical hardware

## File Management and Archiving

### JSON File Organization

- **Sample Data**: `simulator/sample_data.json` - File dati esempio per il simulatore (tracked in git)
- **Generated Events**: Tutti i file JSON generati dai download vengono automaticamente archiviati in `backend/past_events/`
- **Auto-cleanup**: I file più vecchi di 30 giorni vengono rimossi automaticamente

### .gitignore Policy

```
*.json                          # Esclude tutti i JSON
!simulator/sample_data.json     # Eccetto i dati campione del simulatore
!.claude/settings.local.json    # Eccetto le impostazioni Claude
backend/past_events/            # Esclude l'intera directory archivio
```

### Download Behavior

Il backend ora:
1. Scarica eventi dal distributore/simulatore
2. **Salva solo il file JSON** (rimuove l'HTML)
3. **Sposta il JSON in `backend/past_events/`**
4. **Esegue cleanup automatico** dei file > 30 giorni
5. Processa i dati per la dashboard



### Setup Produzione

#### Metodo Semplice (Raccomandato)
```bash
# macOS/Linux
./start.sh --ip <DISTRIBUTOR_IP>

# Windows
start.bat --ip <DISTRIBUTOR_IP>
```

Lo script automaticamente:
- Pulisce la cache Vite
- Fa build del frontend Vue.js
- Avvia API server e frontend
- Gestisce cleanup su Ctrl+C

#### Setup Manuale (Deployment Server)
```bash
# Copiare solo la cartella dist + backend
frontend-vue/dist/  → Servito da python3 -m http.server
backend/           → API server Python

# Avvio (2 comandi)
cd frontend-vue/dist && python3 -m http.server 3000 &
cd backend && python3 api_server.py --ip 0.0.0.0 --port 8000 &
```

## Docker Deployment

### Quick Start

Il progetto include una configurazione Docker completa con 3 container indipendenti:
- **Frontend**: Vue.js + nginx (porta 3000)
- **Backend**: Flask API server (porta 8000)
- **Simulator**: Flask simulator per testing (porta 1500)

#### Setup Iniziale

```bash
# 1. Copia il file di configurazione (stesso file usato per esecuzione locale!)
cp .env.example .env

# 2. Modifica .env con le tue impostazioni
# - Per TESTING/DEVELOPMENT: DISTRIBUTOR_IP=localhost (auto-convertito a "simulator" in Docker)
# - Per PRODUCTION: DISTRIBUTOR_IP=192.168.1.65 (IP del tuo distributore)
```

**IMPORTANTE**: Il sistema usa **un solo file `.env`** sia per esecuzione locale che Docker!
- `DISTRIBUTOR_IP=localhost` → In Docker diventa automaticamente `simulator` (container)
- `DISTRIBUTOR_IP=192.168.1.65` → Funziona identico in locale e Docker

#### Comandi Docker

```bash
# SIMULATION MODE (con simulatore per testing)
docker-compose --profile simulation up

# PRODUCTION MODE (connessione a distributore reale)
docker-compose up

# Avvio in background (detached mode)
docker-compose --profile simulation up -d

# Vedere i logs
docker-compose logs -f              # Tutti i servizi
docker-compose logs -f backend      # Solo backend
docker-compose logs -f frontend     # Solo frontend

# Fermare tutti i container
docker-compose down

# Fermare e rimuovere anche i volumi (ATTENZIONE: cancella database!)
docker-compose down -v

# Rebuild dopo modifiche al codice
docker-compose build
docker-compose up --build
```

#### Gestione Container Individuale

```bash
# Avviare solo il simulatore (per sviluppo)
docker-compose up simulator

# Avviare solo backend (se frontend già in esecuzione)
docker-compose up backend

# Fermare un singolo container
docker-compose stop backend
docker-compose stop frontend
docker-compose stop simulator

# Riavviare un container
docker-compose restart backend
```

### Architettura Docker

```
┌─────────────────────────────────────────────────────────┐
│                    Docker Network                       │
│                  (tecnotouch-network)                   │
│                                                         │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────┐ │
│  │  Frontend    │    │   Backend    │    │Simulator │ │
│  │  (nginx)     │◄───┤   (Flask)    │◄───┤ (Flask)  │ │
│  │  Port 3000   │    │   Port 8000  │    │Port 1500 │ │
│  └──────────────┘    └──────────────┘    └──────────┘ │
│                            │                            │
│                            ▼                            │
│                   ┌─────────────────┐                  │
│                   │  Docker Volumes │                  │
│                   │  - db-data      │                  │
│                   │  - event-archives│                 │
│                   └─────────────────┘                  │
└─────────────────────────────────────────────────────────┘
          │                                    │
     Port 3000                            Port 1500
      (Frontend)                         (Simulator)
```

**Comunicazione interna:**
- Frontend nginx fa proxy delle chiamate `/api/*` → `http://backend:8000`
- Backend si connette a `DISTRIBUTOR_IP:1500` (può essere `simulator` o IP reale)
- Tutti i container condividono la stessa rete Docker

**Volumi persistenti:**
- `db-data`: Database SQLite (`sales_data.db`)
- `event-archives`: Archivio eventi ultimi 30 giorni (`backend/past_events/`)

### Modalità Development vs Production

#### Development Mode (con hot-reload)

In `docker-compose.yml`, i volumi sono configurati per montare il codice sorgente:

```yaml
volumes:
  - ./backend:/app          # Hot-reload per modifiche backend
  - ./shared:/app/shared    # Hot-reload per configurazione
```

Questo permette di modificare il codice e vedere i cambiamenti senza rebuild.

**Vantaggi:**
- Modifiche immediate visibili
- Sviluppo più veloce
- Debug più semplice

**Svantaggi:**
- Performance leggermente ridotte
- Non identico all'ambiente production

#### Production Mode (solo artifacts)

Per production, commenta i volumi di hot-reload in `docker-compose.yml`:

```yaml
volumes:
  - db-data:/app/data
  - event-archives:/app/past_events
  # - ./backend:/app          # COMMENTATO per production
  # - ./shared:/app/shared    # COMMENTATO per production
```

Poi rebuild:

```bash
docker-compose --env-file .env.docker build
docker-compose --env-file .env.docker up -d
```

### Scenari d'uso Comuni

#### 1. Testing in Tabaccheria (senza distributore reale)

```bash
# Setup
cp .env.example .env
# Modifica: DISTRIBUTOR_IP=localhost (auto-convertito a "simulator" in Docker)

# Avvio
docker-compose --profile simulation up

# Accesso
http://localhost:3000  # Dashboard
```

#### 2. Produzione in Tabaccheria (distributore reale)

```bash
# Setup
cp .env.example .env
# Modifica: DISTRIBUTOR_IP=192.168.1.65
# Modifica: DISTRIBUTOR_PASSWORD=tua_password

# Avvio
docker-compose up -d

# Accesso
http://localhost:3000  # Dashboard
```

#### 3. Sviluppo con Simulatore sempre attivo

```bash
# Terminal 1: Avvia simulatore
docker-compose up simulator

# Terminal 2: Lavora su frontend/backend
# (oppure avvia anche gli altri container)
docker-compose up frontend backend

# Accesso
http://localhost:1500  # Simulatore API
http://localhost:3000  # Dashboard
```

#### 4. Switch tra Simulatore e Distributore Reale

```bash
# Cambio in .env:
# Da: DISTRIBUTOR_IP=localhost
# A:  DISTRIBUTOR_IP=192.168.1.65

# Riavvia solo il backend (frontend non serve rebuild)
docker-compose restart backend
```

### Troubleshooting Docker

#### Container non si avvia

```bash
# Vedere i logs per capire l'errore
docker-compose logs backend
docker-compose logs frontend
docker-compose logs simulator

# Verificare health check
docker ps  # Controlla lo stato (healthy/unhealthy)
```

#### Errore "cannot connect to backend"

```bash
# Verifica che il backend sia healthy
docker ps | grep backend

# Testa la connessione al backend
docker exec -it tecnotouch-frontend wget -O- http://backend:8000/health

# Verifica la configurazione nginx
docker exec -it tecnotouch-frontend cat /etc/nginx/nginx.conf | grep backend
```

#### Database corrotto o vuoto

```bash
# Rimuovi il volume e ricrea
docker-compose down -v
docker-compose up

# Oppure backup e restore manuale
docker cp tecnotouch-backend:/app/data/sales_data.db ./backup.db
docker cp ./backup.db tecnotouch-backend:/app/data/sales_data.db
```

#### Port già in uso

```bash
# Cambia porta in .env
FRONTEND_PORT=3001  # Invece di 3000
API_PORT=8001       # Invece di 8000

# Riavvia
docker-compose down
docker-compose up
```

#### Rebuild completo (cache cleared)

```bash
# Ferma tutto
docker-compose down

# Rimuovi immagini
docker-compose build --no-cache

# Riavvia
docker-compose up
```

### File Docker nel Progetto

```
.
├── docker-compose.yml              # Orchestrazione 3 container
├── .env.example                    # Template configurazione (unificato locale + Docker)
├── .dockerignore                   # File esclusi dal build (root)
├── backend/
│   └── Dockerfile                  # Container Flask API
├── simulator/
│   └── Dockerfile                  # Container Flask simulator
└── frontend-vue/
    ├── Dockerfile                  # Container Vue.js + nginx
    ├── .dockerignore               # File esclusi dal build (frontend)
    └── docker/
        └── nginx.conf              # Configurazione nginx
```

### Best Practices Docker

1. **Un solo file `.env`** usato sia per esecuzione locale che Docker (no conflitti!)
2. **Auto-conversion intelligente**: `DISTRIBUTOR_IP=localhost` → Docker lo converte automaticamente a `simulator`
3. **Mai committare `.env`** (contiene credenziali)
4. **Backup regolare** del volume `db-data`
5. **Monitoring logs** con `docker-compose logs -f`
6. **Health checks** per verificare stato container
7. **Profile `simulation`** solo quando serve il simulatore
8. **Rimuovere volumi** solo se vuoi resettare tutto
